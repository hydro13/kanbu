// Kanbu Database Schema
// Multi-tenant project management platform
// Based on Kanboard schema analysis (DOC-01 through DOC-05)
//
// Modified by Session 88ca040e-8890-4144-8c81-3661c8cdd582 on 2025-12-28
// Change: Added reminderAt field to Task model (EXT-04)
//
// Modified by Session 2fb1aa57-4c11-411a-bfda-c7de543d538f on 2025-12-29
// Change: Added ApiKey, Webhook, WebhookDelivery models (EXT-14)
//
// Modified by Session a99141c4-b96b-462e-9b59-2523b3ef47ce on 2025-12-29
// Change: Added Invite, SystemSetting models and invitesSent relation (ADMIN-01)
//
// Modified on 2026-01-02
// Change: Task 253 - Extended Workspace model with logoUrl, createdById for multi-workspace support
//
// Modified on 2026-01-05
// Change: Added AD-style Groups system (Group, GroupMember) for LDAP-compatible permissions
//
// Modified on 2026-01-09
// Change: Added AI Assistant binding (AssistantSetupCode, AssistantBinding) for Claude Code MCP integration (Fase 9.7)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MULTI-TENANCY: Workspace (Tenant) Isolation
// ============================================================================

model Workspace {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(100)
  description String?  @db.Text
  logoUrl     String?  @map("logo_url") @db.VarChar(500)
  settings    Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy       User?               @relation("WorkspaceCreator", fields: [createdById], references: [id])
  // REMOVED: users WorkspaceUser[] (legacy - replaced by ACL)
  projects        Project[]
  projectGroups   ProjectGroup[]
  invitations     WorkspaceInvitation[]
  logo            WorkspaceLogo?
  groups          Group[]             // AD-style groups for this workspace
  roleAssignments RoleAssignment[]    // Security groups assigned to this workspace
  auditLogs       AuditLog[]          // Audit logs scoped to this workspace
  apiKeys         ApiKey[]            // API keys scoped to this workspace (Fase 9.6)
  githubInstallations GitHubInstallation[]  // GitHub App installations (Fase 1)
  githubUserMappings  GitHubUserMapping[]   // GitHub user mappings (Fase 1)

  @@map("workspaces")
}

model WorkspaceLogo {
  id          Int      @id @default(autoincrement())
  workspaceId Int      @unique @map("workspace_id")
  data        Bytes    // Binary image data
  mimeType    String   @map("mime_type") @db.VarChar(50)
  size        Int      // File size in bytes
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_logos")
}

// REMOVED: WorkspaceUser model (legacy - replaced by ACL system)
// Migration: 2026-01-08 - Fase 8 Database Cleanup

model WorkspaceInvitation {
  id          Int           @id @default(autoincrement())
  workspaceId Int           @map("workspace_id")
  email       String        @db.VarChar(255)
  role        WorkspaceRole @default(MEMBER)
  token       String        @unique @db.VarChar(64)
  expiresAt   DateTime      @map("expires_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  createdBy   Int           @map("created_by")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User      @relation(fields: [createdBy], references: [id])

  @@map("workspace_invitations")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// App-level role for system administration
// NOTE: ADMIN role = SYSTEM_ADMIN (can create/manage workspaces, users, system settings)
enum AppRole {
  ADMIN    // Full system access - workspace creation, user management, settings (= SYSTEM_ADMIN)
  MANAGER  // Limited management - can manage projects within assigned workspaces
  USER     // Standard user (DEFAULT) - normal workspace member
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique @db.VarChar(255)
  username      String    @unique @db.VarChar(100)
  name          String    @db.VarChar(255)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  timezone      String    @default("Europe/Amsterdam") @db.VarChar(50)
  language      String    @default("nl") @db.VarChar(10)
  settings      Json      @default("{}")
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  role          AppRole   @default(USER) // App-level admin role
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Security - 2FA
  twofactorActivated   Boolean   @default(false) @map("twofactor_activated")
  twofactorSecret      String?   @db.Char(16) @map("twofactor_secret")

  // Security - Brute force protection
  failedLoginCount     Int       @default(0) @map("failed_login_count")
  lockedUntil          DateTime? @map("locked_until")
  lockoutCount         Int       @default(0) @map("lockout_count") // Number of times account was locked (for exponential backoff)

  // OAuth providers
  googleId             String?   @db.VarChar(255) @map("google_id")
  githubId             String?   @db.VarChar(30) @map("github_id")
  gitlabId             Int?      @map("gitlab_id")

  // Preferences
  theme                String    @default("system") @db.VarChar(20)
  defaultFilter        String?   @db.Text @map("default_filter")

  // Public access
  publicToken          String?   @unique @db.VarChar(64) @map("public_token")

  // Budgettering
  hourlyRate           Decimal?  @db.Decimal(10, 2) @map("hourly_rate")

  // Notification preferences
  notificationsEnabled Boolean   @default(true) @map("notifications_enabled")
  notificationFilter   Int       @default(4) @map("notification_filter") // 1=all, 2=assigned, 3=created, 4=both

  // Relations
  // REMOVED: workspaces WorkspaceUser[] (legacy - replaced by ACL)
  workspacesCreated  Workspace[]           @relation("WorkspaceCreator")
  invitationsCreated WorkspaceInvitation[]
  // REMOVED: projectMembers ProjectMember[] (legacy - replaced by ACL)
  tasksCreated       Task[]                @relation("TaskCreator")
  tasksAssigned      TaskAssignee[]
  subtasksAssigned   Subtask[]
  comments           Comment[]
  attachments        Attachment[]
  sessions           Session[]
  rememberTokens     RememberToken[]
  notifications      Notification[]
  activities         Activity[]
  apiKeys            ApiKey[]
  passwordResets     PasswordReset[]
  lastLogins         LastLogin[]
  metadata           UserMetadata[]
  notificationSettings UserNotificationSetting[]
  avatar             UserAvatar?
  invitesSent        Invite[]              @relation("UserInvites")
  groupMemberships   GroupMember[]         // AD-style group memberships
  groupMembersAdded  GroupMember[]         @relation("GroupMemberAddedBy")
  pagePreferences    UserPagePreference[]  // Per-device page width preferences
  aclEntriesCreated  AclEntry[]            @relation("AclCreator") // ACL entries created by this user
  auditLogs          AuditLog[]            @relation("AuditLogActor") // Audit logs created by this user
  assistantSetupCodes AssistantSetupCode[]  // AI Assistant setup codes (MCP pairing)
  assistantBindings  AssistantBinding[]     // AI Assistant machine bindings
  githubUserMappings GitHubUserMapping[]    // GitHub user mappings (Fase 1)

  @@map("users")
}

model Session {
  id        String   @id @db.VarChar(64)
  userId    Int      @map("user_id")
  data      Json     @default("{}")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model RememberToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.VarChar(64)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("remember_tokens")
}

// System-level invite for new users (different from WorkspaceInvitation)
model Invite {
  id          Int       @id @default(autoincrement())
  email       String    @db.VarChar(255)
  token       String    @unique @db.VarChar(64)
  role        AppRole   @default(USER)
  invitedById Int       @map("invited_by")
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  invitedBy User @relation("UserInvites", fields: [invitedById], references: [id])

  @@map("invites")
}

// System settings key-value store
model SystemSetting {
  key       String   @id @db.VarChar(100)
  value     String?  @db.Text
  changedBy Int?     @map("changed_by")
  changedAt DateTime @default(now()) @updatedAt @map("changed_at")

  @@map("system_settings")
}

// ============================================================================
// PROJECTS
// ============================================================================

model Project {
  id             Int       @id @default(autoincrement())
  workspaceId    Int       @map("workspace_id")
  name           String    @db.VarChar(255)
  identifier     String?   @db.VarChar(10) // e.g., "PLAN" for PLAN-123
  description    String?   @db.Text
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  isActive       Boolean   @default(true) @map("is_active")
  isPublic       Boolean   @default(false) @map("is_public")
  settings       Json      @default("{}")
  lastActivityAt DateTime? @map("last_activity_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  workspace       Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  // REMOVED: members ProjectMember[] (legacy - replaced by ACL)
  columns         Column[]
  swimlanes       Swimlane[]
  tasks           Task[]
  tags            Tag[]
  categories      Category[]
  customFields    CustomField[]
  modules         Module[]
  milestones      Milestone[]
  sprints         Sprint[]
  budgets         Budget[]
  wikiPages       WikiPage[]
  activities      Activity[]
  projectGroups   ProjectGroupMember[]
  webhooks        Webhook[]
  groups          Group[]              // AD-style groups for this project
  roleAssignments RoleAssignment[]     // Security groups assigned to this project
  features        Feature[]            // ACL-controlled menu items/features (Fase 8B)
  apiKeys         ApiKey[]             // API keys scoped to this project (Fase 9.6)
  githubRepository GitHubRepository?   // Linked GitHub repository (Fase 1)

  @@unique([workspaceId, identifier])
  @@map("projects")
}

// REMOVED: ProjectMember model (legacy - replaced by ACL system)
// Migration: 2026-01-08 - Fase 8 Database Cleanup

enum ProjectRole {
  OWNER
  MANAGER
  MEMBER
  VIEWER
}

// ============================================================================
// FEATURE ACCESS CONTROL (Fase 8B + 8C)
// Menu items and features as ACL resources for fine-grained UI control
// ============================================================================
//
// Scope determines where this feature belongs:
// - 'dashboard'  : Dashboard menu items (overview, widgets, shortcuts, recent-projects)
// - 'profile'    : User profile features (settings, notifications, api-keys, sessions)
// - 'admin'      : System administration (users, groups, acl, invites, system-settings)
// - 'project'    : Project-specific features (board, list, calendar, analytics, etc.)
//
// For 'project' scope, projectId links to specific project.
// For other scopes, projectId is NULL and feature is system-wide.

model Feature {
  id          Int      @id @default(autoincrement())
  scope       String   @db.VarChar(20)       // 'dashboard' | 'profile' | 'admin' | 'project'
  projectId   Int?     @map("project_id")    // Only for scope='project', null for system features
  slug        String   @db.VarChar(50)       // e.g., 'analytics', 'sprints', 'admin.users'
  name        String   @db.VarChar(100)      // Display name
  description String?  @db.Text
  icon        String?  @db.VarChar(50)       // Icon identifier for UI
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Unique per scope: system features by scope+slug, project features by project+slug
  @@unique([scope, projectId, slug])
  @@index([scope])
  @@map("features")
}

// ============================================================================
// BOARD STRUCTURE: Columns & Swimlanes
// ============================================================================

model Column {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  title       String   @db.VarChar(255)
  description String?  @db.Text
  position    Int      @default(0)
  taskLimit   Int      @default(0) @map("task_limit") // WIP limit, 0 = no limit
  isCollapsed Boolean  @default(false) @map("is_collapsed")
  showClosed  Boolean  @default(false) @map("show_closed")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("columns")
}

model Swimlane {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  position    Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("swimlanes")
}

// ============================================================================
// TASKS
// ============================================================================

model Task {
  id             Int       @id @default(autoincrement())
  projectId      Int       @map("project_id")
  columnId       Int       @map("column_id")
  swimlaneId     Int?      @map("swimlane_id")
  creatorId      Int       @map("creator_id")
  title          String    @db.VarChar(500)
  description    String?   @db.Text
  reference      String?   @db.VarChar(50) // External reference
  priority       Int       @default(0) // 0=low, 1=medium, 2=high, 3=urgent
  score          Int       @default(0) // Story points / complexity
  progress       Int       @default(0) // 0-100
  position       Int       @default(0)
  color          String?   @db.VarChar(20)
  dateStarted    DateTime? @map("date_started")
  dateDue        DateTime? @map("date_due")
  dateCompleted  DateTime? @map("date_completed")
  reminderAt     DateTime? @map("reminder_at") // When to send reminder notification
  timeEstimated  Float     @default(0) @map("time_estimated") // Hours
  timeSpent      Float     @default(0) @map("time_spent") // Hours
  isActive       Boolean   @default(true) @map("is_active") // false = closed
  isDraggable    Boolean   @default(true) @map("is_draggable")
  recurrenceData Json?     @map("recurrence_data")
  githubBranch   String?   @db.VarChar(255) @map("github_branch") // Feature branch name (Fase 1)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Optional GENX relations
  milestoneId Int? @map("milestone_id")
  moduleId    Int? @map("module_id")
  sprintId    Int? @map("sprint_id")
  categoryId  Int? @map("category_id")

  // Relations
  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  column       Column            @relation(fields: [columnId], references: [id])
  swimlane     Swimlane?         @relation(fields: [swimlaneId], references: [id])
  creator      User              @relation("TaskCreator", fields: [creatorId], references: [id])
  milestone    Milestone?        @relation(fields: [milestoneId], references: [id])
  module       Module?           @relation(fields: [moduleId], references: [id])
  sprint       Sprint?           @relation(fields: [sprintId], references: [id])
  category     Category?         @relation(fields: [categoryId], references: [id])
  assignees    TaskAssignee[]
  subtasks     Subtask[]
  comments     Comment[]
  attachments  Attachment[]
  tags         TaskTag[]
  customValues TaskCustomValue[]
  linksFrom    TaskLink[]        @relation("TaskLinkFrom")
  linksTo      TaskLink[]        @relation("TaskLinkTo")
  genxSessions TaskSession[]
  githubIssue        GitHubIssue?        // Linked GitHub issue (Fase 1)
  githubPullRequests GitHubPullRequest[] // Linked pull requests (Fase 1)
  githubCommits      GitHubCommit[]      // Linked commits (Fase 1)

  @@index([projectId, isActive])
  @@index([columnId])
  @@index([dateDue])
  @@map("tasks")
}

model TaskAssignee {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignees")
}

model Subtask {
  id            Int           @id @default(autoincrement())
  taskId        Int           @map("task_id")
  title         String        @db.VarChar(500)
  description   String?       @db.Text
  status        SubtaskStatus @default(TODO)
  position      Int           @default(0)
  assigneeId    Int?          @map("assignee_id")
  timeEstimated Float         @default(0) @map("time_estimated") // Hours
  timeSpent     Float         @default(0) @map("time_spent") // Hours
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  task     Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignee User? @relation(fields: [assigneeId], references: [id])

  @@map("subtasks")
}

enum SubtaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

model Comment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@map("comments")
}

// ============================================================================
// TAGS & CATEGORIES
// ============================================================================

model Tag {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  name      String   @db.VarChar(100)
  color     String   @default("grey") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   TaskTag[]

  @@unique([projectId, name])
  @@map("tags")
}

model TaskTag {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@map("task_tags")
}

model Category {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  color       String   @default("blue") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@unique([projectId, name])
  @@map("categories")
}

// ============================================================================
// ATTACHMENTS & LINKS
// ============================================================================

model Attachment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  name      String   @db.VarChar(255)
  path      String   @db.VarChar(500)
  mimeType  String?  @map("mime_type") @db.VarChar(100)
  size      Int      @default(0) // Bytes
  isImage   Boolean  @default(false) @map("is_image")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@map("attachments")
}

model TaskLink {
  id             Int          @id @default(autoincrement())
  taskId         Int          @map("task_id")
  oppositeTaskId Int          @map("opposite_task_id")
  linkType       TaskLinkType @default(RELATES_TO) @map("link_type")
  createdAt      DateTime     @default(now()) @map("created_at")

  // Relations
  task         Task @relation("TaskLinkFrom", fields: [taskId], references: [id], onDelete: Cascade)
  oppositeTask Task @relation("TaskLinkTo", fields: [oppositeTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, oppositeTaskId, linkType])
  @@map("task_links")
}

enum TaskLinkType {
  RELATES_TO
  BLOCKS
  IS_BLOCKED_BY
  DUPLICATES
  IS_DUPLICATED_BY
  IS_CHILD_OF
  IS_PARENT_OF
  FOLLOWS
  IS_FOLLOWED_BY
  FIXES
  IS_FIXED_BY
}

// ============================================================================
// CUSTOM FIELDS
// ============================================================================

model CustomField {
  id         Int             @id @default(autoincrement())
  projectId  Int             @map("project_id")
  name       String          @db.VarChar(255)
  type       CustomFieldType @default(TEXT)
  options    Json? // For dropdown: ["Option 1", "Option 2"]
  isRequired Boolean         @default(false) @map("is_required")
  position   Int             @default(0)
  createdAt  DateTime        @default(now()) @map("created_at")

  // Relations
  project Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  values  TaskCustomValue[]

  @@unique([projectId, name])
  @@map("custom_fields")
}

model TaskCustomValue {
  id            Int      @id @default(autoincrement())
  taskId        Int      @map("task_id")
  customFieldId Int      @map("custom_field_id")
  value         String   @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([taskId, customFieldId])
  @@map("task_custom_values")
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  CHECKBOX
  DROPDOWN
  URL
  EMAIL
}

// ============================================================================
// GENX ENTITIES: Sprints
// ============================================================================

model Sprint {
  id          Int          @id @default(autoincrement())
  projectId   Int          @map("project_id")
  name        String       @db.VarChar(255)
  description String?      @db.Text
  status      SprintStatus @default(PLANNING)
  dateStart   DateTime     @map("date_start") @db.Date
  dateEnd     DateTime     @map("date_end") @db.Date
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
}

// ============================================================================
// GENX ENTITIES: Modules (Phases/Feature Areas)
// ============================================================================

model Module {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  color       String   @default("blue") @db.VarChar(20)
  position    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@unique([projectId, name])
  @@map("modules")
}

// ============================================================================
// GENX ENTITIES: Milestones
// ============================================================================

model Milestone {
  id          Int       @id @default(autoincrement())
  projectId   Int       @map("project_id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  dateDue     DateTime? @map("date_due") @db.Date
  isCompleted Boolean   @default(false) @map("is_completed")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("milestones")
}

// ============================================================================
// GENX ENTITIES: Sticky Notes
// ============================================================================

model StickyNote {
  id         Int              @id @default(autoincrement())
  userId     Int              @map("user_id")
  title      String?          @db.VarChar(255)
  content    String           @db.Text
  color      StickyNoteColor  @default(YELLOW)
  isPinned   Boolean          @default(false) @map("is_pinned")
  visibility StickyVisibility @default(PRIVATE)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  // Relations - polymorphic links
  links StickyNoteLink[]

  @@map("sticky_notes")
}

model StickyNoteLink {
  id           Int            @id @default(autoincrement())
  stickyNoteId Int            @map("sticky_note_id")
  entityType   StickyLinkType @map("entity_type")
  entityId     Int            @map("entity_id")
  createdAt    DateTime       @default(now()) @map("created_at")

  // Relations
  stickyNote StickyNote @relation(fields: [stickyNoteId], references: [id], onDelete: Cascade)

  @@unique([stickyNoteId, entityType, entityId])
  @@map("sticky_note_links")
}

enum StickyNoteColor {
  YELLOW
  PINK
  BLUE
  GREEN
  PURPLE
  ORANGE
}

enum StickyVisibility {
  PRIVATE
  PUBLIC
}

enum StickyLinkType {
  PROJECT
  TASK
  SPRINT
  WIKI_PAGE
  PROJECT_GROUP
}

// ============================================================================
// GENX ENTITIES: Project Groups
// ============================================================================

model ProjectGroup {
  id          Int                @id @default(autoincrement())
  workspaceId Int                @map("workspace_id")
  name        String             @db.VarChar(255)
  description String?            @db.Text
  color       String             @default("blue") @db.VarChar(20)
  status      ProjectGroupStatus @default(DRAFT)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  // Relations
  workspace Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projects  ProjectGroupMember[]

  @@map("project_groups")
}

model ProjectGroupMember {
  id             Int      @id @default(autoincrement())
  projectGroupId Int      @map("project_group_id")
  projectId      Int      @map("project_id")
  position       Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  projectGroup ProjectGroup @relation(fields: [projectGroupId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectGroupId, projectId])
  @@map("project_group_members")
}

enum ProjectGroupStatus {
  DRAFT
  PLANNED
  ACTIVE
  COMPLETED
  CLOSED
}

// ============================================================================
// GENX ENTITIES: Task-Session Links (Connection to GENX V5)
// ============================================================================

model TaskSession {
  id        Int             @id @default(autoincrement())
  taskId    Int             @map("task_id")
  sessionId String          @map("session_id") @db.VarChar(36) // UUID from GENX V5
  linkType  TaskSessionType @default(WORKED_ON) @map("link_type")
  notes     String?         @db.Text
  createdAt DateTime        @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, sessionId, linkType])
  @@index([sessionId])
  @@map("task_sessions")
}

enum TaskSessionType {
  WORKED_ON
  CREATED
  REVIEWED
  MENTIONED
}

// ============================================================================
// BUDGETS
// ============================================================================

model Budget {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  name      String   @db.VarChar(255)
  amount    Decimal  @db.Decimal(15, 2)
  currency  String   @default("EUR") @db.VarChar(3)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lines   BudgetLine[]

  @@map("budgets")
}

model BudgetLine {
  id          Int            @id @default(autoincrement())
  budgetId    Int            @map("budget_id")
  description String         @db.VarChar(500)
  amount      Decimal        @db.Decimal(15, 2)
  lineType    BudgetLineType @default(EXPENSE) @map("line_type")
  taskId      Int?           @map("task_id")
  createdAt   DateTime       @default(now()) @map("created_at")

  // Relations
  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@map("budget_lines")
}

enum BudgetLineType {
  EXPENSE
  INCOME
}

// ============================================================================
// WIKI
// ============================================================================

model WikiPage {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  title      String   @db.VarChar(255)
  content    String   @db.Text
  creatorId  Int?     @map("creator_id")
  modifierId Int?     @map("modifier_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("wiki_pages")
}

// ============================================================================
// API KEYS & WEBHOOKS
// ============================================================================

// API Key scope levels (Fase 9.6)
enum ApiKeyScope {
  USER      // Full user access (legacy behavior)
  WORKSPACE // Scoped to specific workspace
  PROJECT   // Scoped to specific project
}

model ApiKey {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  name        String    @db.VarChar(255)
  keyPrefix   String    @map("key_prefix") @db.VarChar(8) // First 8 chars for identification
  keyHash     String    @map("key_hash") @db.VarChar(255) // Hashed full key
  permissions Json      @default("[]") // Array of permission strings (deprecated - use ACL)

  // Scope fields (Fase 9.6)
  scope              ApiKeyScope @default(USER)
  workspaceId        Int?        @map("workspace_id")
  projectId          Int?        @map("project_id")

  // Service account (Fase 9.6)
  isServiceAccount   Boolean     @default(false) @map("is_service_account")
  serviceAccountName String?     @map("service_account_name") @db.VarChar(100)

  rateLimit   Int       @default(100) @map("rate_limit") // Requests per minute
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([workspaceId])
  @@index([projectId])
  @@map("api_keys")
}

model Webhook {
  id            Int       @id @default(autoincrement())
  projectId     Int       @map("project_id")
  name          String    @db.VarChar(255)
  url           String    @db.VarChar(500)
  secret        String    @db.VarChar(64) // For HMAC signature verification
  events        Json      @default("[]") // Array of event types to trigger on
  isActive      Boolean   @default(true) @map("is_active")
  lastSuccess   DateTime? @map("last_success")
  lastFailure   DateTime? @map("last_failure")
  failureCount  Int       @default(0) @map("failure_count")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@map("webhooks")
}

model WebhookDelivery {
  id          Int      @id @default(autoincrement())
  webhookId   Int      @map("webhook_id")
  event       String   @db.VarChar(100)
  payload     Json
  statusCode  Int?     @map("status_code")
  response    String?  @db.Text
  duration    Int?     // Response time in ms
  success     Boolean  @default(false)
  attempts    Int      @default(1)
  deliveredAt DateTime @default(now()) @map("delivered_at")

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, deliveredAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// NOTIFICATIONS & ACTIVITY
// ============================================================================

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String   @db.VarChar(100)
  title     String   @db.VarChar(255)
  content   String?  @db.Text
  data      Json     @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model Activity {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  userId     Int?     @map("user_id")
  eventType  String   @db.VarChar(100)
  entityType String   @db.VarChar(50)
  entityId   Int      @map("entity_id")
  changes    Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id])

  @@index([projectId, createdAt])
  @@map("activities")
}

// ============================================================================
// USER PROFILE EXTENSIONS
// ============================================================================

model PasswordReset {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.VarChar(80)
  expiresAt DateTime @map("expires_at")
  ip        String   @db.VarChar(45)
  userAgent String   @map("user_agent") @db.VarChar(255)
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model LastLogin {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  authType  String   @map("auth_type") @db.VarChar(25) // 'password', 'remember_me', 'oauth'
  ip        String   @db.VarChar(45)
  userAgent String   @map("user_agent") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("last_logins")
}

model UserMetadata {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  key       String   @db.VarChar(100)
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@map("user_metadata")
}

model UserNotificationSetting {
  id               Int     @id @default(autoincrement())
  userId           Int     @map("user_id")
  notificationType String  @map("notification_type") @db.VarChar(50) // 'email', 'web'
  isEnabled        Boolean @default(true) @map("is_enabled")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@map("user_notification_settings")
}

model UserAvatar {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  data      Bytes    // Binary image data
  mimeType  String   @map("mime_type") @db.VarChar(50)
  size      Int      // File size in bytes
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_avatars")
}

// User page width preferences (per device)
model UserPagePreference {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  deviceId    String   @map("device_id") @db.VarChar(36) // UUID stored in localStorage
  pagePath    String   @map("page_path") @db.VarChar(255) // e.g., "/project/KANBU/board"
  isFullWidth Boolean  @default(false) @map("is_full_width")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId, pagePath])
  @@index([userId, deviceId])
  @@map("user_page_preferences")
}

// ============================================================================
// AD-STYLE GROUPS: LDAP-Compatible Permission System
// ============================================================================
// Groups follow Active Directory naming conventions for future LDAP integration:
// - "Domain Admins" (super-admin) - Full system access
// - "workspace-{slug}" - Workspace membership
// - "workspace-{slug}-admins" - Workspace admin rights
// - "project-{identifier}" - Project membership
// - "project-{identifier}-admins" - Project admin rights
//
// Supports:
// - Nested groups (group in group)
// - Allow/Deny permissions (Deny always wins)
// - Membership expiration
// - LDAP-compatible structure

model Group {
  id              Int         @id @default(autoincrement())

  // LDAP-compatible identifiers
  objectGuid      String      @unique @default(uuid()) @map("object_guid") @db.VarChar(36)
  name            String      @unique @db.VarChar(255)   // sAMAccountName: "Domain Admins", "workspace-develop"
  displayName     String      @map("display_name") @db.VarChar(255)  // Human readable: "Domain Admins", "Workspace: Develop"
  distinguishedName String?   @unique @map("distinguished_name") @db.VarChar(500)  // CN=Editors,OU=Kanbu,DC=local
  description     String?     @db.Text

  // Type and scope
  type            GroupType
  scope           GroupScope  @default(DOMAIN_LOCAL)

  // Scope - which entity this group is associated with (null for system groups)
  workspaceId     Int?        @map("workspace_id")
  projectId       Int?        @map("project_id")

  // Nested groups - parent group relationship
  parentGroupId   Int?        @map("parent_group_id")
  parentGroup     Group?      @relation("GroupHierarchy", fields: [parentGroupId], references: [id])
  childGroups     Group[]     @relation("GroupHierarchy")

  // LDAP integration
  externalId      String?     @unique @map("external_id") @db.VarChar(255)  // External system ID
  source          GroupSource @default(LOCAL)

  // Metadata
  isSystem        Boolean     @default(false) @map("is_system")  // System groups cannot be deleted
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Security Group flag - can be assigned to multiple objects via RoleAssignment
  isSecurityGroup Boolean     @default(false) @map("is_security_group")

  // Relations
  workspace       Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project         Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members         GroupMember[]
  permissions     GroupPermission[]
  roleAssignments RoleAssignment[]

  @@index([type])
  @@index([workspaceId])
  @@index([projectId])
  @@index([parentGroupId])
  @@map("groups")
}

model GroupMember {
  id           Int       @id @default(autoincrement())
  groupId      Int       @map("group_id")
  userId       Int       @map("user_id")

  // Membership type
  memberType   MemberType @default(DIRECT) @map("member_type")

  // Expiration support (like AD account expiration)
  expiresAt    DateTime? @map("expires_at")

  // Audit
  addedAt      DateTime  @default(now()) @map("added_at")
  addedById    Int?      @map("added_by")

  // LDAP sync metadata
  externalSync Boolean   @default(false) @map("external_sync")

  // Relations
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedBy User? @relation("GroupMemberAddedBy", fields: [addedById], references: [id])

  @@unique([groupId, userId])
  @@index([userId])
  @@index([expiresAt])
  @@map("group_members")
}

// Permission definition - all available permissions in the system
model Permission {
  id          Int      @id @default(autoincrement())

  // Identifier
  name        String   @unique @db.VarChar(100)  // "tasks.create", "sprints.manage"
  displayName String   @map("display_name") @db.VarChar(255)  // "Create Tasks"
  description String?  @db.Text

  // Categorization
  category    String   @db.VarChar(50)  // "tasks", "sprints", "milestones", "system"

  // Hierarchy (for inheritance, e.g., "tasks.edit" under "tasks")
  parentId    Int?     @map("parent_id")
  parent      Permission?   @relation("PermissionHierarchy", fields: [parentId], references: [id])
  children    Permission[]  @relation("PermissionHierarchy")

  // UI ordering
  sortOrder   Int      @default(0) @map("sort_order")

  // Metadata
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  groupPermissions GroupPermission[]

  @@index([category])
  @@index([parentId])
  @@map("permissions")
}

// Group-Permission mapping with Allow/Deny (like Windows NTFS)
model GroupPermission {
  id           Int        @id @default(autoincrement())

  groupId      Int        @map("group_id")
  permissionId Int        @map("permission_id")

  // Access type - DENY always overrides ALLOW (like Windows)
  accessType   AccessType @default(ALLOW) @map("access_type")

  // Scope override - where does this permission apply?
  // NULL = everywhere the group has scope
  // Set = only for this specific workspace/project
  workspaceId  Int?       @map("workspace_id")
  projectId    Int?       @map("project_id")

  // Inheritance tracking
  inherited    Boolean    @default(false)  // Was this inherited from parent group?

  // Audit
  createdAt    DateTime   @default(now()) @map("created_at")
  createdById  Int?       @map("created_by")

  // Relations
  group       Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission  Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId, workspaceId, projectId])
  @@index([groupId])
  @@index([permissionId])
  @@index([workspaceId])
  @@index([projectId])
  @@map("group_permissions")
}

// Group types for different permission scopes
enum GroupType {
  SYSTEM           // "Domain Admins" - full system access
  WORKSPACE        // "workspace-{slug}" - workspace member
  WORKSPACE_ADMIN  // "workspace-{slug}-admins" - workspace admin
  PROJECT          // "project-{identifier}" - project member
  PROJECT_ADMIN    // "project-{identifier}-admins" - project admin
  CUSTOM           // User-created custom groups
}

// Group scope (AD-compatible)
enum GroupScope {
  DOMAIN_LOCAL     // Only within this domain
  GLOBAL           // Can have members from trusted domains
  UNIVERSAL        // Can be used anywhere in forest
}

// Membership type
enum MemberType {
  DIRECT           // Directly added to group
  NESTED           // Member via nested group
  DYNAMIC          // Dynamically assigned (future: rules-based)
}

// Access type for permissions (Windows-style)
enum AccessType {
  ALLOW
  DENY             // DENY always overrides ALLOW
}

// Source of the group (for LDAP sync)
enum GroupSource {
  LOCAL            // Created in Kanbu
  LDAP             // Synced from LDAP/Active Directory
  AZURE_AD         // Synced from Azure AD
  SCIM             // Via SCIM provisioning
}

// ============================================================================
// ROLE ASSIGNMENTS: AD-Style Security Group Access Control
// ============================================================================
// Role assignments allow Security Groups to be assigned to multiple workspaces
// and projects with specific roles. This enables:
// - Cross-workspace groups ("All Developers" with access to multiple workspaces)
// - Inheritance (workspace role flows down to projects)
// - Flexible security without 1:1 group-to-object binding

model RoleAssignment {
  id                Int      @id @default(autoincrement())

  // The security group being assigned
  groupId           Int      @map("group_id")
  group             Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Target scope - exactly one should be set
  workspaceId       Int?     @map("workspace_id")
  workspace         Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projectId         Int?     @map("project_id")
  project           Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Role within this scope
  role              AssignmentRole @default(MEMBER)

  // Should this role inherit to children?
  // If true: Workspace role flows to all Projects
  inheritToChildren Boolean  @default(true) @map("inherit_to_children")

  // Audit
  createdAt         DateTime @default(now()) @map("created_at")
  createdById       Int?     @map("created_by")

  @@unique([groupId, workspaceId, projectId])
  @@index([groupId])
  @@index([workspaceId])
  @@index([projectId])
  @@map("role_assignments")
}

// Role levels for assignments (maps to existing WorkspaceRole/ProjectRole)
enum AssignmentRole {
  VIEWER           // Read-only access
  MEMBER           // Normal member access
  MANAGER          // Can manage content, limited admin
  ADMIN            // Full admin within scope
  OWNER            // Ultimate control (typically only one per scope)
}

// =============================================================================
// ACL SYSTEM - Filesystem-style permissions
// =============================================================================
//
// Based on NTFS/AD permission model:
// - Permissions as bitmask (R=1, W=2, X=4, D=8, P=16)
// - Direct ACL entries on resources (workspaces, projects, etc.)
// - Inheritance from parent to child
// - Deny always overrides Allow
//
// Permission bits:
//   R (1)  = Read      - View resource, list contents
//   W (2)  = Write     - Create children (new tasks, new projects)
//   X (4)  = Execute   - Perform actions (move tasks, change status)
//   D (8)  = Delete    - Remove resource
//   P (16) = Permissions - Manage ACL entries for this resource
//
// Common combinations:
//   Read only      = R         = 1
//   Contributor    = R+W+X     = 7
//   Editor         = R+W+X+D   = 15
//   Full Control   = R+W+X+D+P = 31

model AclEntry {
  id              Int         @id @default(autoincrement())

  // Resource this ACL applies to
  resourceType    String      @map("resource_type") @db.VarChar(50)  // 'workspace', 'project', 'admin', 'profile'
  resourceId      Int?        @map("resource_id")                     // null = root level (e.g., /admin for all admin)

  // Principal (who gets this permission)
  principalType   String      @map("principal_type") @db.VarChar(10)  // 'user' | 'group'
  principalId     Int         @map("principal_id")                     // user.id or group.id

  // Permission bitmask (R=1, W=2, X=4, D=8, P=16)
  permissions     Int         @default(0)                              // 0-31 bitmask

  // Deny flag - if true, these permissions are explicitly denied
  // Deny ALWAYS overrides Allow (like NTFS)
  deny            Boolean     @default(false)

  // Inheritance tracking
  inherited       Boolean     @default(false)                          // Was this inherited from parent?
  inheritToChildren Boolean   @default(true) @map("inherit_to_children") // Should this propagate to children?

  // Audit trail
  createdAt       DateTime    @default(now()) @map("created_at")
  createdById     Int?        @map("created_by")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  createdBy       User?       @relation("AclCreator", fields: [createdById], references: [id])

  @@unique([resourceType, resourceId, principalType, principalId, deny])
  @@index([resourceType, resourceId])
  @@index([principalType, principalId])
  @@index([inherited])
  @@map("acl_entries")
}

// ============================================================================
// AUDIT LOGGING - Security Event Tracking
// ============================================================================
//
// Fase 9.1: Comprehensive audit trail for all security-critical events.
// Categories: ACL, GROUP, USER, WORKSPACE, SETTINGS
// Access: Workspace admins see their workspace logs, Domain Admins see all.
//
// Added: 2026-01-08
// ============================================================================

model AuditLog {
  id            Int       @id @default(autoincrement())

  // Event classification
  category      String    @db.VarChar(30)     // 'ACL', 'GROUP', 'USER', 'WORKSPACE', 'SETTINGS'
  action        String    @db.VarChar(50)     // 'acl:granted', 'user:created', etc.

  // Target resource (what was affected)
  resourceType  String    @map("resource_type") @db.VarChar(50)  // 'workspace', 'project', 'user', 'group', 'setting'
  resourceId    Int?      @map("resource_id")                     // ID of the affected resource
  resourceName  String?   @map("resource_name") @db.VarChar(255)  // Human-readable name for display

  // Secondary target (e.g., user added to group, member added to workspace)
  targetType    String?   @map("target_type") @db.VarChar(50)    // 'user', 'group'
  targetId      Int?      @map("target_id")
  targetName    String?   @map("target_name") @db.VarChar(255)

  // Change tracking
  changes       Json      @default("{}")      // { before: {...}, after: {...} }
  metadata      Json      @default("{}")      // Additional context

  // Actor (who performed the action)
  userId        Int       @map("user_id")

  // Scope for filtering (workspaceId enables workspace admins to see their logs)
  workspaceId   Int?      @map("workspace_id")

  // Request context (for security analysis)
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.Text

  // Timestamp
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  user          User      @relation("AuditLogActor", fields: [userId], references: [id])
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@index([category, createdAt])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([userId, createdAt])
  @@index([workspaceId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// AI ASSISTANT BINDING - Claude Code MCP Integration
// ============================================================================
//
// Fase 9.7: One-time setup code pairing for Claude Code MCP server.
// Users generate a temporary setup code in their profile page, tell it to
// Claude, and receive a permanent token bound to their machine.
//
// Security model:
// - Setup codes: KNB-XXXX-XXXX format, 5 min TTL, one-time use
// - Permanent tokens: 256-bit entropy, bcrypt hashed, machine-bound
// - ACL inheritance: Claude inherits user's permissions dynamically
//
// Added: 2026-01-09
// ============================================================================

/// Temporary setup code for pairing (5 min TTL, one-time use)
model AssistantSetupCode {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  code        String    @unique @db.VarChar(14)  // KNB-XXXX-XXXX format
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime  @map("expires_at")       // createdAt + 5 min
  consumedAt  DateTime? @map("consumed_at")      // Set when exchanged for token
  machineId   String?   @map("machine_id") @db.VarChar(64)  // Set when consumed

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([expiresAt])
  @@map("assistant_setup_codes")
}

/// Permanent binding between user and machine (after setup code exchange)
model AssistantBinding {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  machineId     String    @map("machine_id") @db.VarChar(64)  // Hash of hostname+user
  machineName   String?   @map("machine_name") @db.VarChar(100)  // Human readable: "MAX (Linux)"
  tokenHash     String    @map("token_hash") @db.VarChar(255)    // bcrypt hash of token
  tokenPrefix   String    @map("token_prefix") @db.VarChar(12)   // ast_xxxxxxxx for logs
  createdAt     DateTime  @default(now()) @map("created_at")
  lastUsedAt    DateTime? @map("last_used_at")
  revokedAt     DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, machineId])
  @@index([tokenPrefix])
  @@index([revokedAt])
  @@map("assistant_bindings")
}

// =============================================================================
// GITHUB CONNECTOR - Fase 1: Database Infrastructure
// =============================================================================
//
// Two-tier architecture:
// - Admin (Workspace level): GitHubInstallation, GitHubUserMapping
// - Project level: GitHubRepository, GitHubIssue, GitHubPullRequest, GitHubCommit, GitHubSyncLog
//
// Enables:
// - Bidirectional issue synchronization
// - Pull request tracking with task linking
// - Commit tracking via task references
// - Feature branch creation from tasks
// - Automatic task status updates
//
// Added: 2026-01-09
// =============================================================================

/// GitHub App Installation (org/user level) - Workspace scoped
model GitHubInstallation {
  id              Int       @id @default(autoincrement())
  workspaceId     Int       @map("workspace_id")
  installationId  BigInt    @unique @map("installation_id")
  accountType     String    @db.VarChar(20)  // 'user' | 'organization'
  accountId       BigInt    @map("account_id")
  accountLogin    String    @db.VarChar(255) @map("account_login")
  accessToken     String?   @db.Text @map("access_token")  // Encrypted
  tokenExpiresAt  DateTime? @map("token_expires_at")
  permissions     Json      @default("{}")
  events          String[]  @default([])
  suspendedAt     DateTime? @map("suspended_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  repositories    GitHubRepository[]

  @@index([workspaceId])
  @@index([accountLogin])
  @@map("github_installations")
}

/// User Mapping: GitHub Login  Kanbu User (Workspace Level)
model GitHubUserMapping {
  id              Int       @id @default(autoincrement())
  workspaceId     Int       @map("workspace_id")
  userId          Int       @map("user_id")
  githubLogin     String    @db.VarChar(255) @map("github_login")
  githubId        BigInt?   @map("github_id")
  githubEmail     String?   @db.VarChar(255) @map("github_email")
  githubAvatarUrl String?   @db.VarChar(512) @map("github_avatar_url")
  autoMatched     Boolean   @default(false) @map("auto_matched")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, githubLogin])
  @@unique([workspaceId, userId])
  @@index([githubLogin])
  @@map("github_user_mappings")
}

/// GitHub Repository linked to Kanbu Project (1:1)
model GitHubRepository {
  id              Int       @id @default(autoincrement())
  projectId       Int       @unique @map("project_id")
  installationId  Int       @map("installation_id")
  repoId          BigInt    @map("repo_id")
  owner           String    @db.VarChar(255)
  name            String    @db.VarChar(255)
  fullName        String    @db.VarChar(512) @map("full_name")
  defaultBranch   String    @default("main") @db.VarChar(255) @map("default_branch")
  isPrivate       Boolean   @default(false) @map("is_private")
  syncEnabled     Boolean   @default(true) @map("sync_enabled")
  syncSettings    Json      @default("{}") @map("sync_settings")
  lastSyncAt      DateTime? @map("last_sync_at")
  webhookId       BigInt?   @map("webhook_id")
  webhookSecret   String?   @db.VarChar(255) @map("webhook_secret")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  installation    GitHubInstallation @relation(fields: [installationId], references: [id])
  issues          GitHubIssue[]
  pullRequests    GitHubPullRequest[]
  commits         GitHubCommit[]
  syncLogs        GitHubSyncLog[]

  @@unique([owner, name])
  @@index([installationId])
  @@map("github_repositories")
}

/// Synced GitHub Issues
model GitHubIssue {
  id              Int       @id @default(autoincrement())
  repositoryId    Int       @map("repository_id")
  taskId          Int?      @unique @map("task_id")
  issueNumber     Int       @map("issue_number")
  issueId         BigInt    @map("issue_id")
  title           String    @db.VarChar(500)
  state           String    @db.VarChar(20)  // 'open' | 'closed'
  syncDirection   String    @default("bidirectional") @db.VarChar(20) @map("sync_direction")
  lastSyncAt      DateTime? @map("last_sync_at")
  syncHash        String?   @db.VarChar(64) @map("sync_hash")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  repository      GitHubRepository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  task            Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@unique([repositoryId, issueNumber])
  @@map("github_issues")
}

/// Pull Requests linked to Tasks
model GitHubPullRequest {
  id              Int       @id @default(autoincrement())
  repositoryId    Int       @map("repository_id")
  taskId          Int?      @map("task_id")
  prNumber        Int       @map("pr_number")
  prId            BigInt    @map("pr_id")
  title           String    @db.VarChar(500)
  state           String    @db.VarChar(20)  // 'open' | 'closed' | 'merged'
  headBranch      String    @db.VarChar(255) @map("head_branch")
  baseBranch      String    @db.VarChar(255) @map("base_branch")
  authorLogin     String    @db.VarChar(255) @map("author_login")
  mergedAt        DateTime? @map("merged_at")
  closedAt        DateTime? @map("closed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  repository      GitHubRepository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  task            Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@unique([repositoryId, prNumber])
  @@index([taskId])
  @@map("github_pull_requests")
}

/// Commits linked to Tasks
model GitHubCommit {
  id              Int       @id @default(autoincrement())
  repositoryId    Int       @map("repository_id")
  taskId          Int?      @map("task_id")
  sha             String    @db.VarChar(40)
  message         String    @db.Text
  authorName      String    @db.VarChar(255) @map("author_name")
  authorEmail     String    @db.VarChar(255) @map("author_email")
  authorLogin     String?   @db.VarChar(255) @map("author_login")
  committedAt     DateTime  @map("committed_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  repository      GitHubRepository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  task            Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@unique([repositoryId, sha])
  @@index([taskId])
  @@map("github_commits")
}

/// Sync Activity Log
model GitHubSyncLog {
  id              Int       @id @default(autoincrement())
  repositoryId    Int       @map("repository_id")
  action          String    @db.VarChar(50)   // 'issue_created', 'pr_linked', etc.
  direction       String    @db.VarChar(20)   // 'kanbu_to_github' | 'github_to_kanbu'
  entityType      String    @db.VarChar(20)   // 'issue' | 'pr' | 'commit' | 'task'
  entityId        String?   @db.VarChar(50)   @map("entity_id")
  details         Json      @default("{}")
  status          String    @default("success") @db.VarChar(20)
  errorMessage    String?   @db.Text @map("error_message")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  repository      GitHubRepository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId, createdAt])
  @@map("github_sync_logs")
}
